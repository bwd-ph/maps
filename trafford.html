<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
        <meta charset="UTF-8"/>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <title>Trafford Data Lab: The Borough of Trafford</title>

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
        <link rel="stylesheet" href="https://www.trafforddatalab.io/css/labBase.css"/>
        <link rel="stylesheet" href="https://www.trafforddatalab.io/assets/leaflet/labLeafletMap.css"/>
        <link rel="stylesheet" href="https://www.trafforddatalab.io/assets/leaflet/extended_markers/extended_markers_base.css"/>
        <link rel="stylesheet" href="https://www.trafforddatalab.io/assets/leaflet/extended_markers/extended_markers_mixed.css"/>

        <style>
            @media (min-width:621px)
            {
                .mainPanelControl
                {
                    width: 280px;   /* desired width when not on mobiles */
                }
            }

            .infoDockContainer
            {
                max-height: 250px;
            }

            .propertiesTable
            {
                width: 100%;
                font-size: 12px;
                background-color: rgba(240,240,240,0.5);
            }

            .propertiesTable td
            {
                vertical-align: top;
            }

            .propertiesTable td:nth-child(1)
            {
                font-weight: bold;
                width: 1%;
            }
        </style>
    </head>

    <body>
        <div id="map" class="mapFullScreen"></div>

        <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.62.0/dist/L.Control.Locate.min.js"></script>
        <script src="https://www.trafforddatalab.io/assets/javascript/labError.js"></script>
        <script src="https://www.trafforddatalab.io/assets/javascript/labAjax.js"></script>
        <script src="https://www.trafforddatalab.io/assets/javascript/labGetQryStrValByKey.js"></script>
        <script src="https://www.trafforddatalab.io/assets/leaflet/labCreateTileLayer.js"></script>
        <script src="https://www.trafforddatalab.io/assets/leaflet/labLeafletMap.js"></script>


        <script>
            // ######### EXTERNAL DATA #########
            var title = labGetQryStrValByKey('title');
            var about = labGetQryStrValByKey('about');
            var dataUrl = labGetQryStrValByKey('data');
            var attr = labGetQryStrValByKey('attr');

            if (title === null) title = 'Trafford';
            if (about === null) about = 'Explore the different geographies within the Local Authority by choosing a layer and then selecting an area.';


            // ######### INITIALISATION #########
            var labMap = new LabLeafletMap({
                title: title,
                about: about
            });

            labMap.baseLayers['Light'].addTo(labMap.map);   // Choose the base/tile layer for the map

            labMap.featureCache = null;    // for caching the feature currently selected

            // Polygon feature styling
            labMap.poly = {
                color: '#212121',
                weight: 2,
                fillOpacity: 0
            };

            // Selected polygon styling
            labMap.polySelected = {
                color: '#ffea00',
                weight: 3,
                fillColor: '#ffff00',
                fillOpacity: '0.5',
                opacity: '1'
            };

            // Point data feature styling
            labMap.marker = L.AwesomeMarkers.icon({
                markerColor: 'pin-circle-orange-bright',
                iconSize: [20, 39]
            });

            // User-selected point data styling
            labMap.markerSelected = L.AwesomeMarkers.icon({
                markerColor: 'pin-circle-yellow-bright',
                iconSize: [20, 39]
            });


            // ######### FUNCTIONS #########
            // To setup each feature within GeoJSON
            function featureEvents (feature, layer) {
                // we need to discover the feature type - remember it is valid for this to be null!
                if (feature.hasOwnProperty('type')) {
                    featureType = feature.type.toLowerCase();

                    if (featureType == 'feature' || featureType == 'featurecollection') {
                        if (feature.hasOwnProperty('geometry') && feature.geometry.hasOwnProperty('type')) featureType = (feature.geometry.type !== null) ? feature.geometry.type.toLowerCase() : null;
                    }
                }

                // based on the feature type we now need to set the correct layer type
                if (featureType == 'point' && feature.hasOwnProperty('properties') && feature.properties.hasOwnProperty('featureRadius') && feature.properties.featureRadius !== '') {
                    layer.type = 'circle';  // special case as there is no circle in GeoJSON - therefore we can only distinguish between a circle and a point if we have a radius value
                }
                else if (featureType == 'point' || featureType == 'multipoint') {
                    layer.type = 'marker';
                }
                else if (featureType == 'polygon' || featureType == 'multipolygon') {
                    layer.type = 'polygon';
                }
                else if (featureType == 'linestring' || featureType == 'multilinestring') {
                    layer.type = 'polyline';
                }
                else {
                    layer.type = featureType;   // probably null
                }

                // Add handler to layer to show properties onclick
                layer.on({
                    click: showLayerProps
                });
            }

            // To setup any point data features within GeoJSON
            function pointData (feature, latlng) {
                if (feature.hasOwnProperty('properties') && feature.properties.hasOwnProperty('featureRadius') && feature.properties.featureRadius !== '') {
                    return L.circle(latlng, { radius: feature.properties.featureRadius });
                }
                else {
                    return L.marker(latlng, { icon: labMap.marker });
                }
            }

            // Reset the styling of a previously selected feature
            function resetFeatureStyle() {
                if (labMap.featureCache != null) {
                    if (labMap.featureCache.target.type == 'marker') {
                        labMap.featureCache.target.setIcon(labMap.marker);
                    }
                    else {
                        // work out if the feature is an overlay externally loaded layer or one of the geographies as the reset process is slightly different
                        if (labMap.overlayData != null && labMap.overlayData.hasLayer(labMap.featureCache.target)) {
                            labMap.overlayData.resetStyle(labMap.featureCache.target);
                        }
                        else {
                            labMap.featureCache.target.setStyle(labMap.poly);
                        }
                    }
                }
            }

            // Show the properties of a selected layer
            function showLayerProps(e) {
                L.DomEvent.stopPropagation(e);  // stop the event bubbling to the map which would cause the information to be removed from the info panel etc.

                var layer = e.target;
                var propsTable = '';

                // reset the style of a previously selected feature
                resetFeatureStyle();

                // set the highlight style of the selected feature
                if (layer.type == 'marker') {
                    layer.setIcon(labMap.markerSelected);
                }
                else {
                    layer.setStyle(labMap.polySelected);
                }

                // set new selected feature in the cache
                labMap.featureCache = e;

                // build the content for the properties table to be displayed
                if (layer.feature.hasOwnProperty('properties')) {
                    var props = layer.feature.properties;

                    for (var key in props) {
                        if (props.hasOwnProperty(key)) propsTable += '<tr><td>' + key + '</td><td>' + props[key] + '</td></tr>';
                    }

                    if (propsTable != '') labMap.updateInfo('<table class="propertiesTable">' + propsTable + '</table>');
                }
            }

            function styleOverlayData(feature) {
                // This funciton is for styling non-point data loaded externally. If it has internal styling use that, otherwise use a default
                var styles = {
                    color: '#fc6721',
                    fillColor: '#fc6721',
                    opacity: 0.5,
                    fillOpacity: 0.2
                };

                var props = feature.properties;
                if (props != null) {
                    if (props['stroke'] != null) styles['color'] = props['stroke'];
                    if (props['stroke-width'] != null) styles['weight'] = props['stroke-width'];
                    if (props['stroke-opacity'] != null) styles['opacity'] = props['stroke-opacity'];
                    if (props['fill'] != null) styles['fillColor'] = props['fill'];
                    if (props['fill-opacity'] != null) styles['fillOpacity'] = props['fill-opacity'];
                }

                return styles;
            }


            // ######### EVENTS #########
            // Reset the map state if any features have been selected
            labMap.map.on('click', (function (e) {
                resetFeatureStyle();    // reset the style of a previously selected feature
                labMap.updateInfo();    // clear and hide the info panel
            }));


            // ######### SPATIAL GEOGRAPHY LAYERS #########
            // Add the Trafford boundary
            labAjax('https://www.trafforddatalab.io/spatial_data/local_authority/2016/trafford_local_authority_full_resolution.geojson', function (data) {
                labMap.boundaryLA = L.geoJSON(data, { attribution: labMap.attributionOS, style: labMap.poly, onEachFeature: featureEvents }).addTo(labMap.map);
                labMap.map.fitBounds(labMap.boundaryLA.getBounds()); // adjust the zoom to fit the boundary to the screen size

                labMap.overlayLayers['Authority boundary'] = labMap.boundaryLA;
                labMap.updateLayerControl();
            });

            // Add the Trafford localities
            labAjax('https://www.trafforddatalab.io/spatial_data/council_defined/trafford_localities.geojson', function (data) {
                labMap.boundaryLocalities = L.geoJSON(data, { attribution: labMap.attributionOS, style: labMap.poly, onEachFeature: featureEvents });

                labMap.overlayLayers['Council-defined localities'] = labMap.boundaryLocalities;
                labMap.updateLayerControl();
            });

            // Add the Trafford wards
            labAjax('https://www.trafforddatalab.io/spatial_data/ward/2017/trafford_ward_full_resolution.geojson', function (data) {
                labMap.boundaryWards = L.geoJSON(data, { attribution: labMap.attributionOS, style: labMap.poly, onEachFeature: featureEvents });

                labMap.overlayLayers['Electoral wards'] = labMap.boundaryWards;
                labMap.updateLayerControl();
            });

            // Add the Trafford MSOAs
            labAjax('https://www.trafforddatalab.io/spatial_data/msoa/2011/trafford_msoa_full_resolution.geojson', function (data) {
                labMap.boundaryMSOAs = L.geoJSON(data, { attribution: labMap.attributionOS, style: labMap.poly, onEachFeature: featureEvents });

                labMap.overlayLayers['Middle Layer Super Output Areas (MSOA)'] = labMap.boundaryMSOAs;
                labMap.updateLayerControl();
            });

            // Add the Trafford LSOAs
            labAjax('https://www.trafforddatalab.io/spatial_data/lsoa/2011/trafford_lsoa_full_resolution.geojson', function (data) {
                labMap.boundaryLSOAs = L.geoJSON(data, { attribution: labMap.attributionOS, style: labMap.poly, onEachFeature: featureEvents });

                labMap.overlayLayers['Lower Layer Super Output Areas (LSOA)'] = labMap.boundaryLSOAs;
                labMap.updateLayerControl();
            });

            // Add the Trafford OAs
            labAjax('https://www.trafforddatalab.io/spatial_data/oa/2011/trafford_oa_generalised.geojson', function (data) {
                labMap.boundaryOAs = L.geoJSON(data, { attribution: labMap.attributionOS, style: labMap.poly, onEachFeature: featureEvents });

                labMap.overlayLayers['Output Areas (OA)'] = labMap.boundaryOAs;
                labMap.updateLayerControl();
            });


            // ######### OVERLAY DATA LAYER #########
            if (dataUrl !== null) {
                // Attempt to load GeoJSON specified in the URL
                labAjax(dataUrl, function (data) {
                    if (data !== null && data !== '') {
                        try {
                            labMap.overlayData = L.geoJSON(data, { style: styleOverlayData, attribution: attr, onEachFeature: featureEvents, pointToLayer: pointData }).addTo(labMap.map);
                            labMap.map.fitBounds(labMap.overlayData.getBounds()); // adjust the zoom to fit the data to the screen size
                        }
                        catch (e) {
                            labError(new LabException("Error attempting to create GeoJSON Leaflet layer: " + e.message));
                        }
                    }
                    else {
                        labError(new LabException("Couldn't find URL: " + dataUrl));
                    }
                });
            }
        </script>
    </body>
</html>
